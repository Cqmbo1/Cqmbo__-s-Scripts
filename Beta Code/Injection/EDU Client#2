// ==UserScript==
// @name         Cqmbo Client + khan hack
// @namespace    http://tampermonkey.net/
// @version      2024-08-08
// @description  Try to take over the world!
// @author       Cqmbo__
// @match        https://www.khanacademy.org/*
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
// @grant        none
// ==/UserScript==

// @exclude      https://www.khanacademy.org/math/pre-algebra/pre-algebra-factors-multiples/pre-algebra-factors-mult/e/factor-pairs
(function() {
    'use strict';

function change() {
    const streaks = document.getElementsByClassName('_776naao');
    const rainbowColors = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3'];

    for (let i = 0; i < streaks.length; i++) {
        streaks[i].textContent = 'Sub to @Cqmbo__ (Click on me)';
        let colorIndex = 0;

        function changeColor() {
            streaks[i].style.color = rainbowColors[colorIndex];
            colorIndex = (colorIndex + 1) % rainbowColors.length;
        }

        streaks[i].addEventListener("click", function() {
            window.open("https://www.youtube.com/@Cqmbo__");
        });

        setInterval(changeColor, 500); // Change color every 500ms
    }

    const headernames1 = document.getElementsByClassName('_azwfqqs');
    const headernames2 = document.getElementsByClassName('_19lfck2n');

    for (let i = 0; i < headernames1.length; i++) {
        headernames1[i].textContent = 'Cqmbo__';
        let colorIndex = 0;

        function changeColor2() {
            if (headernames1[i]){
            headernames1[i].style.color = rainbowColors[colorIndex];
            colorIndex = (colorIndex + 1) % rainbowColors.length;
        }
        }

        headernames1[i].addEventListener("click", function() {
            window.open("https://www.youtube.com/@Cqmbo__");
        });

        setInterval(changeColor2, 500); // Change color every 500ms
    }

    for (let i = 0; i < headernames2.length; i++) {
        headernames2[i].textContent = 'Cqmbo__';
        let colorIndex = 0;

        function changeColor3() {
            headernames2[i].style.color = rainbowColors[colorIndex];
            colorIndex = (colorIndex + 1) % rainbowColors.length;
        }

        headernames2[i].addEventListener("click", function() {
            window.open("https://www.youtube.com/@Cqmbo__");
        });

        setInterval(changeColor3, 500); // Change color every 500ms
    }
}

setInterval(change, 500);




    var isAutoFarming = false;
    var autoFarmInterval;
    var isAutoFarming2 = false;
    var autoFarmInterval2;
    var isAutoWatching = false;
    var autoWatchInterval;
    var isMusicPlayerVisible = false;
    var youtubeIframe = null;
    var youtubeVolume = 100;

        // Create Auto Farm All Button
    var autoFarmAllButton2 = document.createElement('button');
    autoFarmAllButton2.id = 'auto-farm-all-button-2';
    autoFarmAllButton2.textContent = 'Auto Farm All 2 (Disabled)';
    autoFarmAllButton2.style.position = 'fixed';
    autoFarmAllButton2.style.top = '180px';
    autoFarmAllButton2.style.right = '10px';
    autoFarmAllButton2.style.zIndex = '10000';
    autoFarmAllButton2.style.display = 'block'; // Ensure it's visible initially
    autoFarmAllButton2.title = 'Automatically Farms All Videos 2';

    autoFarmAllButton2.addEventListener('click', function() {
        if (!isAutoFarming2) {
            autoFarmAllButton2.textContent = 'Auto Farm All 2(Enabled)';
            startAutoFarmAll2();
        } else {
            autoFarmAllButton2.textContent = 'Auto Farm All 2(Disabled)';
            stopAutoFarmAll2();
        }
    });

    document.body.appendChild(autoFarmAllButton2);

    // Toggle visibility with the 'n' key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'j') {
            autoFarmButton.style.display = autoFarmButton.style.display === 'block' ? 'none' : 'block';
            autoWatchButton.style.display = autoWatchButton.style.display === 'block' ? 'none' : 'block';
            autoFarmAllButton.style.display = autoFarmAllButton.style.display === 'block' ? 'none' : 'block';
            autoFarmAllButton2.style.display = autoFarmAllButton2.style.display === 'block' ? 'none' : 'block';
            toggleMusicPlayer();
            toggleYoutubeIframe();
        }
    });

        // Toggle visibility with the 'n' key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'l') {
            toggleYoutubeIframe();
        }
    });

            // Create Auto Farm Button
    var autoFarmButton = document.createElement('button');
    autoFarmButton.id = 'auto-farm-button';
    autoFarmButton.textContent = 'Auto Farm (Disabled)';
    autoFarmButton.style.position = 'fixed';
    autoFarmButton.style.top = '120px';
    autoFarmButton.style.right = '10px';
    autoFarmButton.style.zIndex = '10000';
    autoFarmButton.style.display = 'block'; // Ensure it's visible initially
    autoFarmButton.title = 'Automatically Farm Points';

    autoFarmButton.addEventListener('click', function() {
        if (!isAutoFarming) {
            autoFarmButton.textContent = 'Auto Farm (Enabled)';
            startAutoFarming();
        } else {
            autoFarmButton.textContent = 'Auto Farm (Disabled)';
            stopAutoFarming();
        }
    });

    // Create Auto Watch Button
    var autoWatchButton = document.createElement('button');
    autoWatchButton.id = 'auto-watch-button';
    autoWatchButton.textContent = 'Auto Watch (Disabled)';
    autoWatchButton.style.position = 'fixed';
    autoWatchButton.style.top = '140px';
    autoWatchButton.style.right = '10px';
    autoWatchButton.style.zIndex = '10000';
    autoWatchButton.style.display = 'block'; // Ensure it's visible initially
    autoWatchButton.title = 'Automatically Watch Videos';

    autoWatchButton.addEventListener('click', function() {
        if (!isAutoWatching) {
            autoWatchButton.textContent = 'Auto Watch (Enabled)';
            startAutoWatching();
        } else {
            autoWatchButton.textContent = 'Auto Watch (Disabled)';
            stopAutoWatching();
        }
    });


    // Create Auto Farm All Button
    var autoFarmAllButton = document.createElement('button');
    autoFarmAllButton.id = 'auto-farm-all-button';
    autoFarmAllButton.textContent = 'Auto Farm All (Disabled)';
    autoFarmAllButton.style.position = 'fixed';
    autoFarmAllButton.style.top = '160px';
    autoFarmAllButton.style.right = '10px';
    autoFarmAllButton.style.zIndex = '10000';
    autoFarmAllButton.style.display = 'block'; // Ensure it's visible initially
    autoFarmAllButton.title = 'Automatically Farms All Videos';

    autoFarmAllButton.addEventListener('click', function() {
        if (!isAutoFarming) {
            autoFarmAllButton.textContent = 'Auto Farm All (Enabled)';
            startAutoFarmAll();
        } else {
            autoFarmAllButton.textContent = 'Auto Farm All (Disabled)';
            stopAutoFarmAll();
        }
    });

    document.body.appendChild(autoFarmButton);
    document.body.appendChild(autoWatchButton);
    document.body.appendChild(autoFarmAllButton);

    function toggleAutoFarming() {
        const button = document.getElementById('auto-farm-button');
        if (!isAutoFarming) {
            button.textContent = 'Auto Farm (Enabled)';
            startAutoFarming();
        } else {
            button.textContent = 'Auto Farm (Disabled)';
            stopAutoFarming();
        }
    }

    function startAutoFarming() {
        clickFarmButton();
        autoFarmInterval = setInterval(clickFarmButton, 1000);
        isAutoFarming = true;
    }

    function stopAutoFarming() {
        clearInterval(autoFarmInterval);
        isAutoFarming = false;
    }

    function clickFarmButton() {
        const muteButton = Array.from(document.querySelectorAll('button')).find(button => button.title === 'Mute (m)');
        if (muteButton && muteButton.getAttribute('aria-pressed') === 'false') {
            muteButton.click();
        }

        const playButton = document.querySelector('[data-testid^="video-play-button"]');
        if (playButton) {
            playButton.click();
        }

        const replayButton = Array.from(document.querySelectorAll('button')).find(button => button.textContent.trim() === 'Replay this video');
        if (replayButton) {
            replayButton.click();
        }
    }

    function toggleAutoWatching() {
        const button = document.getElementById('auto-watch-button');
        if (!isAutoWatching) {
            button.textContent = 'Auto Watch (Enabled)';
            startAutoWatching();
        } else {
            button.textContent = 'Auto Watch (Disabled)';
            stopAutoWatching();
        }
    }

    function startAutoWatching() {
        clickWatchButton();
        autoWatchInterval = setInterval(clickWatchButton, 1000);
        isAutoWatching = true;
    }

    function stopAutoWatching() {
        clearInterval(autoWatchInterval);
        isAutoWatching = false;
    }

    function clickWatchButton() {
        const playButton = document.querySelector('[data-testid^="video-play-button"]');
        if (playButton) {
            playButton.click();
        }

        const replayButton = Array.from(document.querySelectorAll('button')).find(button => button.textContent.trim() === 'Replay this video');
        if (replayButton) {
            watchNextVid();
        }
    }

    function watchNextVid() {
        const nextVid = document.getElementsByClassName('_ixuggsz')[0];
        if (nextVid) {
            nextVid.click();
        }
    }

    function toggleAutoFarmAll() {
        const button = document.getElementById('auto-farm-all-button');
        if (!isAutoFarming) {
            button.textContent = 'Auto Farm All (Enabled)';
            startAutoFarmAll();
        } else {
            button.textContent = 'Auto Farm All (Disabled)';
            stopAutoFarmAll();
        }
    }

    function startAutoFarmAll() {
        autoFarmInterval = setInterval(clickFarmAllButton, 1000);
        isAutoFarming = true;
    }

    function stopAutoFarmAll() {
        clearInterval(autoFarmInterval);
        isAutoFarming = false;
    }

    function clickFarmAllButton() {
        const replayButton = Array.from(document.querySelectorAll('button')).find(button => button.textContent.trim() === 'Replay this video');
        const firstVid = document.getElementsByClassName('_1a0bzlxj')[0];

        if (replayButton) {
            const nextVid = document.getElementsByClassName('_1g3h9gny')[0];
            if (nextVid && nextVid.textContent.includes('Up next: video')) {
                nextVid.click();
            } else {
                firstVid.click();
            }
        } else {
            const playButton = document.querySelector('[data-testid^="video-play-button"]');
            if (playButton) {
                playButton.click();
            }
        }
    }

    function startAutoFarmAll2() {
        autoFarmInterval2 = setInterval(clickFarmAllButton2, 1000);
        isAutoFarming2 = true;
    }

    function stopAutoFarmAll2() {
        clearInterval(autoFarmInterval2);
        isAutoFarming2 = false;
    }

function clickFarmAllButton2() {
    var firstVid = document.getElementsByClassName('_1a0bzlxj')[0];
    var nextVid = document.getElementsByClassName('_ixuggsz')[0];

    setTimeout(function () {
        firstVidCheck();
    }, 100);

    function firstVidCheck() {
        if (firstVid) {
            playVids();  // Start playing videos
        } else {
            firstVid.click();
            setTimeout(playVids, 100);
        }
    }

    function playVids() {
        var replayButton = Array.from(document.querySelectorAll('button')).find(button => button.textContent.trim() === 'Replay this video');
        var playButton = document.querySelector('[data-testid^="video-play-button"]');

        setTimeout(function () {
            if (playButton) {
                playButton.click();
                setTimeout(nextVidCheck, 200);
            }
        }, 100);

        setTimeout(function () {
            if (replayButton) {
                replayButton.click();
                setTimeout(nextVidCheck, 12000);
            }
        }, 10000);
    }

    function nextVidCheck() {
        if (nextVid && nextVid.textContent.includes('Up next: video')) {
            nextVid.click();
            setTimeout(function () {
                playVids();  // Continue playing videos if "Up next" video exists
            }, 100);
        } else if (nextVid && !nextVid.textContent.includes('Up next: video')) {
            // No more "Up next" videos, click the first video to start watching
            firstVid.click();
            setTimeout(function () {
                watchVids();  // Stop playVids and watch the videos
            }, 1000);
        }
    }

    function watchVids() {
        setTimeout(function () {
            var replayButton = Array.from(document.querySelectorAll('button')).find(button => button.textContent.trim() === 'Replay this video');
            var playButton = document.querySelector('[data-testid^="video-play-button"]');

            if (replayButton) {
                replayButton.click();  // Replay the video if replay button appears
            } else if (playButton) {
                playButton.click();  // Start playing if play button appears
            }
        }, 500);
    }

    function vidCheck() {
        if (nextVid && !nextVid.textContent.includes('Up next: video')) {
            firstVid.click();
            setTimeout(function () {
                firstVidCheck();
            }, 1000);
        }
    }
}


    // Music Player Components
    var musicPlayerContainer = document.createElement('div');
    musicPlayerContainer.style.position = 'fixed';
    musicPlayerContainer.style.bottom = '10px';
    musicPlayerContainer.style.right = '200px';
    musicPlayerContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
    musicPlayerContainer.style.color = 'white';
    musicPlayerContainer.style.border = '1px solid #333';
    musicPlayerContainer.style.padding = '10px';
    musicPlayerContainer.style.borderRadius = '5px';
    musicPlayerContainer.style.zIndex = '10000';
    musicPlayerContainer.style.display = 'block'; // Initially visible

    var youtubeInput = document.createElement('input');
    youtubeInput.type = 'text';
    youtubeInput.placeholder = 'Paste YouTube link here...';
    youtubeInput.style.width = '300px';
    youtubeInput.style.marginRight = '10px';
    youtubeInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            playYoutubeLoop(youtubeInput.value);
        }
    });

    var volumeSlider = document.createElement('input');
    volumeSlider.type = 'range';
    volumeSlider.min = 0;
    volumeSlider.max = 100;
    volumeSlider.value = youtubeVolume;
    volumeSlider.style.width = '100px';
    volumeSlider.style.marginLeft = '10px';
    volumeSlider.oninput = function() {
        youtubeVolume = volumeSlider.value;
        adjustYoutubeVolume(youtubeVolume / 100);
    };

    var playButton = document.createElement('button');
    playButton.textContent = '▶️';
    playButton.onclick = playYoutubeAudio;

    var pauseButton = document.createElement('button');
    pauseButton.textContent = '⏸️';
    pauseButton.onclick = pauseYoutubeAudio;

    musicPlayerContainer.appendChild(youtubeInput);
    musicPlayerContainer.appendChild(playButton);
    musicPlayerContainer.appendChild(pauseButton);
    musicPlayerContainer.appendChild(volumeSlider);
    document.body.appendChild(musicPlayerContainer);

    function toggleMusicPlayer() {
        isMusicPlayerVisible = !isMusicPlayerVisible;
        musicPlayerContainer.style.display = isMusicPlayerVisible ? 'none' : 'block';
    }

    function toggleYoutubeIframe() {
        if (youtubeIframe) {
            youtubeIframe.style.display = youtubeIframe.style.display === 'none' ? 'block' : 'none';
        }
    }

    function playYoutubeLoop(youtubeLink) {
        if (!youtubeIframe) {
            youtubeIframe = document.createElement('iframe');
            youtubeIframe.width = 380;
            youtubeIframe.height = 200;
            youtubeIframe.style.position = 'fixed';
            youtubeIframe.style.top = '10px'; // Adjust position
            youtubeIframe.style.right = '500px';
            youtubeIframe.frameBorder = "0";
            youtubeIframe.allow = "autoplay";
            youtubeIframe.allow = "fullscreen";
            youtubeIframe.style.zIndex = '10000';
            document.body.appendChild(youtubeIframe);
        }

        if (youtubeLink.trim() === '') {
            // Clear the iframe if no link is provided
            youtubeIframe.src = '';
            youtubeIframe.style.zIndex = '0';
        } else if (youtubeLink.includes('youtube.com/watch?v=')) {
            const videoId = youtubeLink.split('v=')[1].split('&')[0];
            youtubeIframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&loop=1&playlist=${videoId}&enablejsapi=1&volume=${youtubeVolume}`;
            youtubeIframe.style.display = 'block';
        } else {
            alert('Please provide a valid YouTube link.');
        }
    }

    function pauseYoutubeAudio() {
        if (youtubeIframe) {
            youtubeIframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
        }
    }

    function playYoutubeAudio() {
        if (youtubeIframe) {
            youtubeIframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
        }
    }

    function adjustYoutubeVolume(value) {
        if (youtubeIframe) {
            youtubeIframe.contentWindow.postMessage(`{"event":"command","func":"setVolume","args":[${value * 100}]}`, '*');
        }
    }

    const overlayHTML =
        `<div id="khanhack-overlay" style="position: fixed; top: 10px; right: 10px; background-color: white; padding: 10px; border: 1px solid black; z-index: 1000;">
            <button id="toggle-menu">Toggle Answer List</button>
            <button id="reset-answers">Reset Answer List</button>
            <button id="toggle-video-speed">Enable Video Speed Increase</button>
            <button id="auto-solve">Solve Question</button>
            <button id="auto-solve-all">Solve All Questions</button>
            <button id="auto-solve-all-legit">Solve All Questions Legit</button>
            <button id="show-text">Log Options Text</button>
            <button id="debug-mode">Toggle Debug Mode</button>
            <div id="answer-list" style="display: block;">-Answers-</div>
            <p>M also toggles Menu</p>
        </div>
        `
    ;

    function get(x) { return document.getElementById(x); }

    function resetAnswers() {
        document.getElementById('answer-list').innerHTML = ''; // Clear the answer list
        curAns = 1; // Reset the answer counter
        // Trigger the original fetch process to refresh answers
        simulateFetchRequest(); // This simulates a new fetch to repopulate the answer list
        console.log('Answer list has been reset and refreshed.');
    }

    function handleFetchError(error) {
        console.error('An error occurred:', error);
    }

    function simulateFetchRequest() {
        // Simulate the original fetch request to trigger the fetching process
        const fakeFetchEvent = new Event('fakeFetch');
        document.dispatchEvent(fakeFetchEvent);
    }

    var beep = document.createElement("audio");
    beep.id="beep";
    beep.src="https://www.myinstants.com/media/sounds/erro_WFdM8y9.mp3";
    beep.type="audio/mpeg";
    var played = false;

    var debugmode = localStorage.getItem('shouldtoggledebugmode') || false;

    function playerrorsound() {
        if (debugmode === true){
        played=true;
        beep.play();
        }
    }
    function processAnswers(json) {
        let item, question;
        item = json.data.assessmentItem.item.itemData;
        question = JSON.parse(item).question;

        Object.keys(question.widgets).forEach(widgetName => {
            switch (widgetName.split(" ")[0]) {
                case "numeric-input":
                    freeResponseAnswerFrom(question).log();
                    console.log(question);
                    break;
                case "radio":
                    multipleChoiceAnswerFrom(question).log();
                    console.log(question);
                    break;
                case "expression":
                    expressionAnswerFrom(question).log();
                    console.log(question);
                    break;
                case "dropdown":
                    dropdownAnswerFrom(question).log();
                    console.log(question);
                    break;
                default:
                    console.warn('Unhandled widget type:', widgetName);
                    playerrorsound();
            }
        });
    }

let originalJson = JSON.parse;
JSON.parse = function (jsonString) {
    let parsedData = originalJson(jsonString);

    try {
        if (parsedData.data && parsedData.data.assessmentItem && parsedData.data.assessmentItem.item) {

            let itemData = JSON.parse(parsedData.data.assessmentItem.item.itemData);
            let hasGradedWidget = Object.values(itemData.question.widgets).some(widget => widget.graded === true);
            if (hasGradedWidget) {


                for (let widgetKey in itemData.question.widgets) {



                    let widget = itemData.question.widgets[widgetKey];

                    switch (widget.type) {
    case "numeric-input":
        handleNumeric(widget);
        console.log('numeric-input:', widget);
        break;
    case "interactive-graph":
        handleIntGraph(widget);
        console.log('interactive-graph:', widget);
        break;
    case "grapher":
        handleGrapher(widget);
        console.log('grapher:', widget);
        break;
    case "input-number":
        handleInputNum(widget);
        console.log('input-number:', widget);
        break;
    case "matcher":
        handleMatcher(widget);
        console.log('matcher:', widget);
        break;
    case "categorizer":
        handleCateg(widget);
        console.log('categorizer:', widget);
        break;
    case "label-image":
        handleLabel(widget);
        console.log('label-image:', widget);
        break;
    case "matrix":
        handleMatrix(widget);
        console.log('matrix:', widget);
        break;
                        default:
                    console.warn('Unhandled widget type:', widget.type);
playerrorsound();
                    }
                }
            }
        }
    } catch (error) {
        console.log("Error parsing JSON:", error);
    }

    return parsedData;
};

    let overlay = document.createElement("div");
    overlay.innerHTML = overlayHTML;
    document.body.appendChild(overlay);

    let toggleButton = get("toggle-menu");
    let resetButton = get("reset-answers");
    let toggleVideoSpeedButton = get('toggle-video-speed');
    let answerList = get("answer-list");
    let khOverlay = get("khanhack-overlay");
    let autosolveButton = get("auto-solve");
    let solveallBtn = get("auto-solve-all");
    let showtextbtn = get("show-text");
    let solveallBtnLegit = get("auto-solve-all-legit");
    let debugmodebtn = get("debug-mode");

    if (toggleButton && answerList) {
        toggleButton.onclick = function () {
            if (answerList.style.display === "none") {
                answerList.style.display = "block";
            } else {
                answerList.style.display = "none";
            }
        }
    }

    if (resetButton) {
        resetButton.onclick = resetAnswers;
    }

    document.addEventListener('keydown', (event) => {
        if (event.key === 'k') {
            if (khOverlay) {
                if (khOverlay.style.display === "none" || khOverlay.style.display === "") {
                    khOverlay.style.display = "block";
                } else {
                    khOverlay.style.display = "none";
                }
            }
        }
    });

    'use strict';
    window.loaded = false;

    class Answer {
        constructor(answer, type) {
            this.body = answer;
            this.type = type;
        }

        get isMultiChoice() {
            return this.type === "multiple_choice";
        }

        get isFreeResponse() {
            return this.type === "free_response";
        }

        get isExpression() {
            return this.type === "expression";
        }

        get isDropdown() {
            return this.type === "dropdown";
        }

        log() {
            try {
                const answer = this.body;
                answer.forEach(ans => {
                    if (typeof ans === "string") {
                        if (ans.includes("web+graphie")) {
                            this.body[this.body.indexOf(ans)] = "";
                            this.printImage(ans);
                        } else {
                            answer[answer.indexOf(ans)] = ans.replaceAll("$", "");
                        }
                    }
                });
            } catch (error) {
                handleFetchError(error);
            }
        }
    }

    const originalFetch = window.fetch;
    window.fetch = function () {
        return originalFetch.apply(this, arguments).then(async (res) => {
            try {
                if (res.url.includes("/getAssessmentItem")) {
                    const clone = res.clone();
                    const json = await clone.json();
                    processAnswers(json);
                }

                if (!window.loaded) {
                    // console.clear();
                    window.loaded = true;
                }

                return res;
            } catch (error) {
                handleFetchError(error);
                return res; // Ensure the original response is returned even if an error occurs
            }
        });
    }


    let curAns = 1;

    showtextbtn.onclick = function () {
     const options = document.querySelectorAll('._ssxvf9l');
     const answers = document.querySelectorAll('.answer');
        options.forEach((option) => {
            console.log(option.textContent);
        });
        answers.forEach((answer) => {
            const answerText = normalizeTextForAnswer(answer.textContent);
            console.log(`Unnormalized: ${answer.textContent}, Normalized: ${answerText}`);
        });
        console.log('Grouped: '+answers);
    }
    debugmodebtn.onclick = function () {
        debugmode = !debugmode
        debugmodebtn.textContent = debugmode ? 'Toggle Debug Mode: On' : 'Toggle Debug Mode: Off';
        localStorage.setItem('shouldtoggledebugmode', debugmode);
    }

    setInterval(() => {
        debugmode = localStorage.getItem('shouldtoggledebugmode') || false;
      debugmodebtn.textContent = debugmode === true ? 'Toggle Debug Mode: On' : 'Toggle Debug Mode: Off';
    },10);


function normalizeTextForAnswer(text) {
    // Replace LaTeX math symbols and tags
    text = text.replace(/\\div/g, "÷") // Replace \\div with ÷
               .replace(/\\times|\\cdot|×/g, "×") // Replace \\times, \\cdot, or × with ×
               .replace(/\\dfrac|\\frac/g, "/") // Replace fractions with /
               .replace(/\\left|\\right|\\qquad|\\large/g, "") // Remove unnecessary LaTeX tags
               .replace(/<em>/g, "").replace(/<\\em>/g, "") // Remove <em> tags
               .replace(/\$/g, "") // Remove $ symbols used in math expressions
               .replace(/\\/g, "") // Remove backslashes
               .replace(/\_/g, ""); // Remove underscores

    // Handle fractions (e.g., \\\\frac{1}{1000} -> 1/1000)
    text = text.replace(/\\dfrac{([^{}]+)}{([^{}]+)}/g, "$1 / $2")
               .replace(/\\frac{([^{}]+)}{([^{}]+)}/g, "$1 / $2");

    // Strip specific patterns
    text = text.replace(/ - \| : - : /g, "")
               .replace(/ - \| :-: /g, "")
               .replace(/ : - : \| : - : /g, "")
               .replace(/ :-: \| :-: /g, "")
               .replace(/\| /g, " ")
               .replace(/ \| /g, "")
               .replace(/\$\|/g, "")
               .replace(/ - \| - /g, "")
               .replace(/- - /g, "")
               .replace(/ \| /g, "")
               .replace(/\|/g, "");

    // Remove "text{ " and "}" and also handle "text {"
    text = text.replace(/text\{\s*/g, "")
               .replace(/text \{/g, "")
               .replace(/\}/g, "");

    // Replace 'ell' with 'ℓ'
    text = text.replace(/\bell\b/g, "ℓ");

    // Simplify nested braces and fractions
    text = text.replace(/\{([^{}]+)\}/g, "$1") // Remove single braces
               .replace(/(\d+)\s*\/\s*\{([^{}]*)\}/g, "$1$2") // Flatten fractions with braces
               .replace(/(\d+)\{([^{}]+)\}/g, "$1$2"); // Flatten nested numbers

    // Normalize spacing and punctuation
    text = text.replace(/\s+/g, " ").trim()
               .replace(/\s+\./g, ".")
               .replace(/,\s*/g, ", ");

    // Standardize mathematical operators
    text = text.replace(/\*/g, "×")
               .replace(/([=÷×+\-/])/g, " $1 ")
               .replace(/\s{2,}/g, " ");

    // Add space between letters and numbers if missing
    text = text.replace(/([a-zA-Z])(?=\d)/g, "$1 ");

    // Add space between a number and a lowercase letter if missing
    text = text.replace(/(\d)(?=[a-z])/g, "$1 ");

    // Add space between lowercase and uppercase letters if missing
    text = text.replace(/([a-z])(?=[A-Z])/g, "$1 ");

    // Standardize quotes
    text = text.replace(/“|”/g, '"');

    // Remove invisible characters
    text = text.replace(/[\u200b-\u200d\uFEFF]/g, "");

    return text.trim();
}


function normalizeTextForOption(text) {
    // Use the same replacements as for answers
    text = normalizeTextForAnswer(text);

    // Remove leading letters (e.g., "A45÷3=15" becomes "45÷3=15")
    text = text.replace(/^[a-zA-Z]\s*/, "");

    return text.trim();
}

autosolveButton.onclick = function () {
    const inputs = document.querySelectorAll('.mq-root-block');
    const answers = document.querySelectorAll('.answer');
    const options = document.querySelectorAll('._ssxvf9l');
    const checkbtn = document.querySelectorAll('button[data-testid="exercise-check-answer"]');
    const dropdown = document.querySelectorAll('._');
    const categorizerbtns = document.querySelectorAll('._');
    const categorizertypes = document.querySelectorAll('._');

    let delay = 0;

if (options.length > 0) {
    const element = document.querySelectorAll('._1w6i3h1')[0]; // Adjust the selector if necessary
console.log(element);

    if (element && element.style.borderRadius === '24px') {
        const firstanswer = answers[0];
        if (firstanswer) {
            const answerText = normalizeTextForAnswer(firstanswer.textContent); // Normalize answer text
            options.forEach((option) => {
                const optionText = normalizeTextForOption(option.textContent); // Normalize option text
                console.log("Normalized Option:", optionText);
                console.log("Normalized Answer:", answerText);

                if (optionText === answerText) {
                    console.log("Match Found - Option:", optionText, "Answer:", answerText);
                    setTimeout(() => {
                        if (!option.classList.contains('clicked')) {
                            option.click();
                            option.classList.add('clicked');
                            console.log('Clicking matching option:', optionText);

                            setTimeout(() => {
                                firstanswer.remove();
                            }, 50);

                            setTimeout(() => {
                                checkbtn.forEach((checkb) => {
                                    checkb.click();
                                    console.log('Check button clicked');
                                });
                            }, 250);

                            setTimeout(() => {
                                const nextbtn = document.querySelector('button[data-testid="exercise-next-question"]');
                                console.log('Next question button:', nextbtn);
                                if (nextbtn && !nextbtn.disabled) {
                                    nextbtn.click();
                                    console.log('Next question button clicked');
                                } else {
                                    console.error('Next question button not clickable or found');
                                }
                            }, 2000);
                        }
                    }, delay);
                    delay += 10;
                } else if (answerText.includes('![') && answerText.includes(']')) {
    console.log('hi');
    const text = answerText.split('![')[1].split(']')[0];
    console.log('Extracted text:', text);

    options.forEach((option, index) => {
        const webimg = option.querySelector('.unresponsive-svg-image img'); // Find img inside the current option

        if (webimg) {
            console.log('Found image:', webimg, 'Alt text:', webimg.alt);

            const imgalttext = normalizeTextForAnswer(webimg.alt);
            console.log('Normalized alt text:', imgalttext);

            if (imgalttext === text) {
                setTimeout(() => {
                    if (!option.classList.contains('clicked')) {
                        option.click(); // Click the option
                        option.classList.add('clicked');
                        console.log('Clicking matching option:', imgalttext);

                        setTimeout(() => {
                            firstanswer.remove();
                        }, 50);

                        setTimeout(() => {
                            checkbtn.forEach((checkb) => {
                                checkb.click();
                                console.log('Check button clicked');
                            });
                        }, 250);

                        setTimeout(() => {
                            const nextbtn = document.querySelector('button[data-testid="exercise-next-question"]');
                            console.log('Next question button:', nextbtn);
                            if (nextbtn && !nextbtn.disabled) {
                                nextbtn.click();
                                console.log('Next question button clicked');
                            } else {
                                console.error('Next question button not clickable or found');
                            }
                        }, 2000);
                    }
                }, delay);
                delay += 10;
            }
        } else {
            console.log(`No image found in option at index ${index}`);
        }
    });
}
            });
        }
    } else if (element && element.style.borderRadius === '3px') {
        answers.forEach((answer) => {
            const answerText = normalizeTextForAnswer(answer.textContent); // Normalize answer text
            options.forEach((option) => {
                const optionText = normalizeTextForOption(option.textContent); // Normalize option text
                console.log("Normalized Option:", optionText);
                console.log("Normalized Answer:", answerText);

                if (optionText === answerText) {
                    console.log("Match Found - Option:", optionText, "Answer:", answerText);
                    setTimeout(() => {
                        if (!option.classList.contains('clicked')) {
                            option.click();
                            option.classList.add('clicked');
                            console.log('Clicking matching option:', optionText);

                            setTimeout(() => {
                                answer.remove();
                            }, 50);

                            setTimeout(() => {
                                checkbtn.forEach((checkb) => {
                                    checkb.click();
                                    console.log('Check button clicked');
                                });
                            }, 250);

                            setTimeout(() => {
                                const nextbtn = document.querySelector('button[data-testid="exercise-next-question"]');
                                console.log('Next question button:', nextbtn);
                                if (nextbtn && !nextbtn.disabled) {
                                    nextbtn.click();
                                    console.log('Next question button clicked');
                                } else {
                                    console.error('Next question button not clickable or found');
                                }
                            }, 2000);
                        }
                    }, delay);
                    delay += 10;
                } else if (answerText.includes('![') && answerText.includes(']')) {
    console.log('hi');
    const text = answerText.split('![')[1].split(']')[0];
    console.log('Extracted text:', text);

    options.forEach((option, index) => {
        const webimg = option.querySelector('.unresponsive-svg-image img'); // Find img inside the current option

        if (webimg) {
            console.log('Found image:', webimg, 'Alt text:', webimg.alt);

            const imgalttext = normalizeTextForAnswer(webimg.alt);
            console.log('Normalized alt text:', imgalttext);

            if (imgalttext === text) {
                setTimeout(() => {
                    if (!option.classList.contains('clicked')) {
                        option.click(); // Click the option
                        option.classList.add('clicked');
                        console.log('Clicking matching option:', imgalttext);

                        setTimeout(() => {
                            answer.remove();
                        }, 50);

                        setTimeout(() => {
                            checkbtn.forEach((checkb) => {
                                checkb.click();
                                console.log('Check button clicked');
                            });
                        }, 250);

                        setTimeout(() => {
                            const nextbtn = document.querySelector('button[data-testid="exercise-next-question"]');
                            console.log('Next question button:', nextbtn);
                            if (nextbtn && !nextbtn.disabled) {
                                nextbtn.click();
                                console.log('Next question button clicked');
                            } else {
                                console.error('Next question button not clickable or found');
                            }
                        }, 2000);
                    }
                }, delay);
                delay += 10;
            }
        } else {
            console.log(`No image found in option at index ${index}`);
        }
    });
}
            });
        });
    } else {
        console.warn("Element not found or borderRadius is not 24px or 3px.");
    }
} else if (dropdown.length > 0) {
for(let i = 0; i < dropdown.length; i++) {

const seldropdown = dropdown[i];
seldropdown.click();
const selans = answers[i].textContent;
const answerText = normalizeTextForAnswer(selans)
const dropdownoptions = seldropdown.querySelectorAll('._');
dropdownoptions.forEach((option) => {
const OptionText = normalizeTextForAnswer(option.textContent);
if (OptionText === answerText) {
	if (!option.classList.contains('clicked')) {
              option.click();
  option.classList.add('clicked');
  setTimeout(() => {
answers[i].remove();
}, 50);
setTimeout(() => {
                                checkbtn.forEach((checkb) => {
                                    checkb.click();
                                    console.log('Check button clicked');
                                });
                            }, 250);

                            setTimeout(() => {
                                const nextbtn = document.querySelector('button[data-testid="exercise-next-question"]');
                                console.log('Next question button:', nextbtn);
                                if (nextbtn && !nextbtn.disabled) {
                                    nextbtn.click();
                                    console.log('Next question button clicked');
                                } else {
                                    console.error('Next question button not clickable or found');
                                }
                            }, 2000);
};
}
});
                        }


} else if (categorizerbtns.length > 0) {
const a = categorizerbtns.length / (categorizertypes.length || 2)
for(let i=0; i < a; i++) {
 const selans = answers[i]
if (selans.textContent === 'Prime') {
}
}
    } else if (inputs.length > 0) {
    const firstAnswer = answers[0]; // Select the first answer
    if (firstAnswer) {
        const answerText = normalizeTextForAnswer(firstAnswer.textContent); // Normalize answer text
        const answerTextArray = answerText.match(/(\d+|[a-zA-Z]+|\W)/g); // Split into components
        console.log("Answer split into components:", answerTextArray);

        const binaryOperatorsLatex = {
            '+': 'plus',
            '-': 'minus',
            '*': 'times',
            '⋅': 'cdot',
            '/': 'div',
            '=': '=',
            '≠': 'neq',
            '<': '<',
            '>': '>',
            '≤': 'leq',
            '≥': 'geq',
            '±': 'pm',
            '∞': 'infty',
            '∑': 'sum',
            '∫': 'int',
            '∂': 'partial',
            '∇': 'nabla',
        };

        inputs.forEach((input) => {
            const textarea = document.querySelector('.mq-root-block');
            const mathInputBox = document.querySelector('.mq-textarea textarea'); // Target span.mq-textarea
            if (textarea && mathInputBox) {
                let ariaLabel = 'Math input box: ';

                answerTextArray.forEach((component) => {
                    let element;

                    if (component.trim() === "") {
                        return; // Ignore spaces
                    } else if (/[a-zA-Z]/.test(component)) {
                        // Handle letters
                        if (component === 'f') {
                            element = document.createElement('var');
                            element.className = 'mq-f';
                            element.textContent = 'f';
                        } else {
                            element = document.createElement('var');
                            element.textContent = component;
                        }
                        ariaLabel += `"${component}" `;
                    } else if (binaryOperatorsLatex.hasOwnProperty(component)) {
                        // Handle binary operators
                        element = document.createElement('span');
                        element.className = 'mq-binary-operator';
                        element.textContent = component;
                        console.log(component);
                        ariaLabel += `"${component}" (LaTeX: ${binaryOperatorsLatex[component]}) `;
                    } else if (/\d/.test(component)) {
                        // Split multi-digit numbers into single digits
                        component.split('').forEach((digit) => {
                            const digitElement = document.createElement('span');
                            digitElement.className = 'mq-digit';
                            digitElement.textContent = digit;
                            textarea.appendChild(digitElement);
                            ariaLabel += digit + ' ';
                        });
                        return; // Skip further processing for this component
                    }

                    if (element) {
                        textarea.appendChild(element);
                    }
                });

                // Set the aria-label with the constructed string
                mathInputBox.setAttribute('aria-label', ariaLabel.trim());
                console.log('Aria-label set:', ariaLabel);

                setTimeout(() => {
                    console.log('Typed answer into input field:', answerText);

                    setTimeout(() => {
                        checkbtn.forEach((checkb) => {
                            checkb.click();
                            console.log('Check button clicked for input field');
                        });
                    }, 500);

                    setTimeout(() => {
                        const nextbtn = document.querySelector('button[data-testid="exercise-next-question"]' || 'button[data-testid="exercise-check-answer"]');
                        console.log('Next question button:', nextbtn);
                        if (nextbtn && !nextbtn.disabled) {
                            nextbtn.click();
                            console.log('Next question button clicked');
                        } else {
                            console.error('Next question button not clickable or found');
                        }
                    }, 2000);
                }, delay);
                delay += 10;
            } else {
                console.error("No textarea or mq-textarea found for perseus-math-input");
            }
        });
    }
}

}

let autosolveinterval;
let autosolveintervalLegit;

solveallBtnLegit.onclick = function () {
    if (solveallBtnLegit.innerText === 'Solve All Questions Legit') {
        solveallBtnLegit.innerText = 'Pause Solve All';
        localStorage.setItem('Solve All Legit', true);

        autosolveintervalLegit = setInterval(() => {
            const specialElement = document.querySelector('._1f0fvyce');
            const specialElement2 = document.querySelector('._1g3h9gny');
            const specialElement3 = document.querySelector('._1rihsjro');
            if (specialElement3) {
                specialElement3.click();
                console.log('Special element _1rihsjro clicked');
            } else {
                console.log('No special element _1rihsjro found');
            }
            if (specialElement) {
                specialElement.click();
                console.log('Special element _1f0fvyce clicked');
            } else {
                console.log('No special element _1f0fvyce found');
            }
            if (specialElement2) {
                specialElement2.click();
                console.log('Special element _1g3h9gny clicked');
            } else {
                console.log('No special element _1g3h9gny found');
            }

            autosolveButton.click();
        }, 3500);
    } else {
        solveallBtnLegit.innerText = 'Solve All Questions Legit';
        clearInterval(autosolveintervalLegit);
        autosolveintervalLegit = null;
        localStorage.setItem('Solve All Legit', false);
    }
};

solveallBtn.onclick = function () {
    if (solveallBtn.innerText === 'Solve All Questions') {
        solveallBtn.innerText = 'Pause Solve All';
        localStorage.setItem('Solve All', true);

        autosolveinterval = setInterval(() => {
            const specialElement = document.querySelector('._1f0fvyce');
            const specialElement2 = document.querySelector('._1g3h9gny');
            const specialElement3 = document.querySelector('._1rihsjro');
            if (specialElement3) {
                setTimeout(() => {
                specialElement3.click();
                }, 50);
                console.log('Special element _1rihsjro clicked');
            } else {
                console.log('No special element _1rihsjro found');
            }
            if (specialElement) {
                setTimeout(() => {
                    specialElement.click();
                    console.log('Special element _1f0fvyce clicked');
                }, 50);
            } else {
                console.log('No special element _1f0fvyce found');
            }
            if (specialElement2) {
                setTimeout(() => {
                    specialElement2.click();
                    console.log('Special element _1g3h9gny clicked');
                }, 500);
            } else {
                console.log('No special element _1g3h9gny found');
            }

            autosolveButton.click();
        }, 500);
    } else {
        solveallBtn.innerText = 'Solve All Questions';
        clearInterval(autosolveinterval);
        autosolveinterval = null;
        localStorage.setItem('Solve All', false);
    }
};


function shouldDo() {
    const shouldSolveAllLegit = localStorage.getItem('Solve All Legit');
    console.log(shouldSolveAllLegit);
    if (shouldSolveAllLegit === 'true' || shouldSolveAllLegit === true) {
        solveallBtnLegit.click();
    }

    const shouldSolveAll = localStorage.getItem('Solve All');
    console.log(shouldSolveAll);
    if (shouldSolveAll === 'true' || shouldSolveAll === true) {
        solveallBtn.click();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    shouldDo();
});

    shouldDo();

    function freeResponseAnswerFrom(question) {
        const answer = Object.values(question.widgets).flatMap((widget) => {
            if (widget.options?.answers) {
                return widget.options.answers
                    .filter(answer => answer.status === "correct")
                    .map(answer => {
                        let createPar = document.createElement('section');
                        createPar.innerHTML = answer.value;
                    createPar.id = answer.value;
                    createPar.className = 'answer';
                        document.getElementById('answer-list').append(createPar);
                        curAns++;
                        return answer.value;
                    });
            }
            return [];
        });

        return new Answer(answer, "free_response");
    }

    function multipleChoiceAnswerFrom(question) {
        const answer = Object.values(question.widgets).flatMap((widget) => {
            if (widget.options?.choices) {
                return widget.options.choices
                    .filter(choice => choice.correct)
                    .map(choice => {
                        let createPar = document.createElement('section');
                        createPar.innerHTML = normalizeTextForAnswer(choice.content);
                        createPar.id = normalizeTextForAnswer(choice.content);
                    createPar.className = 'answer';
                        document.getElementById('answer-list').append(createPar);
                        curAns++;
                        return choice.content;
                    });
            }
            return [];
        });

        return new Answer(answer, "multiple_choice");
    }

    function expressionAnswerFrom(question) {
        const answer = Object.values(question.widgets).flatMap((widget) => {
            if (widget.options?.answerForms) {
                return widget.options.answerForms
                    .filter(answer => Object.values(answer).includes("correct"))
                    .map(answer => {
                        let createPar = document.createElement('section');
                        createPar.innerHTML = answer.value;
                    createPar.id = answer.value;
                    createPar.className = 'answer';
                        document.getElementById('answer-list').append(createPar);
                        curAns++;
                        return answer.value;
                    });
            }
            return [];
        });

        return new Answer(answer, "expression");
    }

    function dropdownAnswerFrom(question) {
        const answer = Object.values(question.widgets).flatMap((widget) => {
            if (widget.options?.choices) {
                return widget.options.choices
                    .filter(choice => choice.correct)
                    .map(choice => {
                        let createPar = document.createElement('section');
                        createPar.innerHTML = choice.content;
                    createPar.id = choice.content;
                    createPar.className = 'answer';
                        document.getElementById('answer-list').append(createPar);
                        curAns++;
                        return choice.content;
                    });
            }
            return [];
        });

        return new Answer(answer, "dropdown");
    }

    let showans = [];

    showans.forEach(ans => {
        if (ans.type === 'text') {
            createSection(ans.content);
        } else if (ans.type === 'image') {
            addImgAnswerBlock(ans.content);
        }
    });

    function createSection(content){
        let createPar = document.createElement('section');
        createPar.innerHTML = content;
        createPar.id = content;
        createPar.className = 'answer';
        document.getElementById('answer-list').append(createPar);
    }

const addImgAnswerBlock = (imgSrc) => {
    const answerList = document.getElementById('answer-list');
    const imgholder = document.createElement('div');
    imgholder.className = 'block imgBlock';

    const img = document.createElement('img');
    img.src = imgSrc;

    imgholder.appendChild(img);
    answerList.appendChild(imgholder);
};


function handleRadio(widget) {
    let corAns = widget.options.choices.filter(item => item.correct === true).map(item => item.content);
    let ansArr = [];
    let isNone = widget.options.choices.filter(item => item.isNoneOfTheAbove === true && item.correct === true)

    if (isNone.length > 0) {
        createSection("None of the above");
        return;
    }

    corAns.forEach(answer => {
        const hasGraphie = answer.includes('web+graphie')
        const hasNotGraphie = answer.includes('![]')

        if(hasGraphie || hasNotGraphie == true) {
            if(hasGraphie == true) {
                const split = answer.split('web+graphie');
                const midUrl = split[1].slice(0, -1);
                const finalUrl = 'https' + midUrl + '.svg';
                addImgAnswerBlock(finalUrl);
            } else if(hasNotGraphie == true) {
                const finalUrl = answer.slice(4, -1)
                addImgAnswerBlock(finalUrl);
            }
        } else {
            let cleaned = normalizeTextForAnswer(answer)
            ansArr.push(cleaned)
        }


    })

    if(ansArr.length) {
        ansArr.forEach((ans) => {
        createSection(ans);
        });
    }

}

function handleLabel(widget) {
    let corAns = widget.options.markers.filter(item => item.answers).map(item => item.answers)
    let labels = widget.options.markers.filter(item => item.label).map(item => item.label)
    let ansArr = []

    corAns.forEach((answer, index) => {
        if(labels == 0) {
            let cleaned = normalizeTextForAnswer(answer.toString());
            ansArr.push(cleaned)

        } else {
        let cleaned = normalizeTextForAnswer(answer.toString());
        let finLabel = labels[index].replace('Point ', '').replace(/[.]/g, '').trim() || "";
        let labeledAnswer = `${finLabel}: ${cleaned}`;
        ansArr.push(labeledAnswer)
        }

    })

    if(ansArr.length) {
        ansArr.forEach((ans) => {
        createSection(ans);
        });
    }
}

function handleExpression(widget) {
    let expressionAnswer = widget.options.answerForms[0].value;
    let cleaned = normalizeTextForAnswer(expressionAnswer)
    createSection(cleaned);
}

function handleDropdown(widget) {
    let content = widget.options.choices.filter(item => item.correct === true).map(item => item.content);
    createSection(content[0]);
}

function handleInputNum(widget) {
    let inputNumAnswer = widget.options.value;
    createSection(inputNumAnswer);
}

function handleMatcher(widget) {
    let matchAnswer = widget.options.right;
    matchAnswer.forEach(Answer => createSection(Answer));
}

function handleGrapher(widget) {
    let coords = widget.options.correct.coords;
    coords.forEach(coord => createSection(coord));
}

function handleCateg(widget) {
    let values = widget.options.values;
    let categories = widget.options.categories;
    let labeledValues = values.map(value => categories[value]);
    labeledValues.forEach(label => createSection(label));
}

function handleMatrix(widget) {
    let arrs = widget.options.answers;
    arrs.forEach(arr => createSection(arr));
}

function handleNumeric(widget) {
    console.log(widget);
    const numericAnswer = widget.options.answers[0].value;
    numericAnswer.forEach(Answer => createSection(numericAnswer));
}

function handleIntGraph(widget) {
    let coords = widget.options.correct.coords;
    let validCoords = coords.filter(coord => coord !== undefined);
    validCoords.forEach((validCoord) => {
        createSection(validCoord);
    });;
}

    toggleVideoSpeedButton.onclick = function () {
        if (toggleVideoSpeedButton.innerText === 'Enable Video Speed Increase') {
            toggleVideoSpeedButton.innerText = 'Disable Video Speed Increase';
            document.getElementsByTagName('video')[0].playbackRate = 1;
        } else {
            toggleVideoSpeedButton.innerText = 'Enable Video Speed Increase';
            document.getElementsByTagName('video')[0].playbackRate = 2;
        }
    };
})();

